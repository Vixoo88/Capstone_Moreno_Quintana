{% extends 'base.html' %}
{% load roles_tags %}

{% block content %}
<div class="container py-4" style="max-width: 980px;">
  <div class="glass-card p-4">
    <h3 class="page-title mb-3 d-flex align-items-center gap-2 flex-wrap">
      <i class="bi bi-person-gear"></i>
      <span>Asignar cuidadores ‚Äî {{ fecha|date:"d/m/Y" }}</span>
    </h3>

    <div class="row g-3">
      <!-- Columna izquierda: selecci√≥n y acciones -->
      <div class="col-12 col-md-5">
        <div class="card border-0 shadow-sm">
          <div class="card-header bg-transparent fw-semibold d-flex justify-content-between align-items-center flex-wrap gap-2">
            <span class="d-flex align-items-center gap-1">
              <i class="bi bi-people"></i>
              <span>Seleccionar cuidadoras / TENS</span>
            </span>
            <div class="btn-group btn-group-sm flex-wrap" role="group">
              <button class="btn btn-outline-secondary" type="button" id="btnSelTodas">Todas</button>
              <button class="btn btn-outline-secondary" type="button" id="btnSelNinguna">Ninguna</button>
            </div>
          </div>

          <!-- Lista con scroll; las acciones quedan sticky al fondo -->
          <div class="card-body card-scroll d-flex flex-column">
            <form method="post" action="{% url 'asignaciones_generar' %}" id="formGenerar" class="flex-grow-1">
              {% csrf_token %}
              {% if cuidadoras %}
                {% for c in cuidadoras %}
                  <div class="form-check mb-2">
                    <input
                      class="form-check-input cuidadora-check"
                      type="checkbox"
                      name="cuidadores"
                      id="c_{{ c.id }}"
                      value="{{ c.id }}"
                      {% if c.id in seleccion_ids %}checked{% endif %}
                    >
                    <label class="form-check-label d-flex justify-content-between w-100 gap-2" for="c_{{ c.id }}">
                      <span class="text-truncate d-flex align-items-center gap-2">
                        {{ c.get_full_name|default:c.username }}
                        {% if c|is_tens %}
                          <span class="badge rounded-pill small"
                                style="background-color:#00B6FF; color:#ffffff;">
                            TENS
                          </span>


                        {% else %}
                          <span class="badge rounded-pill small"
                                style="background-color:#ff69b4; color:#ffffff;">
                            Cuidador/a
                          </span>

                        {% endif %}
                      </span>
                    </label>
                  </div>
                {% endfor %}
              {% else %}
                <div class="text-muted">No hay cuidadoras o TENS activas.</div>
              {% endif %}

              <hr class="my-3">

              <button class="btn btn-gradient w-100 mb-2" title="Genera la asignaci√≥n y env√≠a el resumen al grupo de Telegram">
                <i class="bi bi-shuffle me-1"></i>Generar asignaci√≥n equitativa
              </button>
              <div class="form-text small mb-3">
                Si no seleccionas ninguna, se usar√°n <b>todas</b> las cuidadoras/TENS activas por defecto.
              </div>
            </form>

            <!-- ACCIONES STICKY: siempre visibles en m√≥vil -->
            <div class="sticky-actions d-flex flex-column flex-sm-row gap-2">
              <form method="post" action="{% url 'asignaciones_toggle_modo' %}" class="flex-fill">
                {% csrf_token %}
                <input type="hidden" name="solo_asignados" value="{{ solo_asignados|yesno:'0,1' }}">
                <button class="btn btn-outline-secondary w-100"
                        onclick="this.previousElementSibling.value='{{ solo_asignados|yesno:'1,0' }}'">
                  {% if solo_asignados %}
                    <i class="bi bi-people me-1"></i>Ver TODOS (quitar restricci√≥n)
                  {% else %}
                    <i class="bi bi-person-check me-1"></i>Solo ASIGNADOS (restringir)
                  {% endif %}
                </button>
              </form>

              <form method="post" action="{% url 'asignaciones_limpiar' %}" class="flex-fill">
                {% csrf_token %}
                <button class="btn btn-outline-danger w-100">
                  <i class="bi bi-x-circle me-1"></i>Quitar asignaciones
                </button>
              </form>
            </div>
          </div>
        </div>

        <!-- Avisos por Telegram -->
        <div class="card border-0 shadow-sm mt-3">
          <div class="card-header bg-transparent fw-semibold d-flex align-items-center gap-2">
            <i class="bi bi-send-check"></i><span>Enviar aviso por Telegram</span>
          </div>
          <div class="card-body">
            <form method="post" action="{% url 'asignaciones_avisar_meds' %}" id="formAviso">
              {% csrf_token %}
              <textarea name="mensaje" class="form-control form-control-sm" rows="2"
                placeholder="Escribe el aviso‚Ä¶">üíä Medicamentos de hoy est√°n listos para retiro en Farmacia. Por favor pasar a buscar y administrar. Gracias.</textarea>
              <div class="d-flex gap-2 mt-2">
                <button class="btn btn-outline-success w-100">
                  <i class="bi bi-send me-1"></i>Enviar aviso
                </button>
                <button type="button" class="btn btn-outline-secondary w-100"
                  onclick="this.closest('form').querySelector('textarea').value='üíä Medicamentos listos. Pasar a buscar por Farmacia. Gracias.'">
                  Mensaje corto
                </button>
              </div>
              <div class="form-text small mt-1">Se enviar√° al grupo configurado del bot.</div>
            </form>
          </div>
        </div>
      </div>

      <!-- Columna derecha: resumen actual -->
      <div class="col-12 col-md-7">
        <div class="card border-0 shadow-sm h-100">
          <div class="card-header bg-transparent fw-semibold d-flex align-items-center gap-2">
            <i class="bi bi-list-check"></i>
            <span>Asignaciones de hoy</span>
            <span class="badge bg-secondary ms-auto">{{ grupos|length }} cuidador(es)</span>
          </div>

          <div class="card-body">
            {% if grupos %}
              <div class="row row-cols-1 row-cols-md-2 g-3">
                {% for cuid, lista in grupos.items %}
                  <div class="col">
                    <div class="border rounded-3 p-2 h-100">
                      <div class="fw-semibold mb-2 d-flex align-items-center gap-1">
                        <i class="bi bi-person-heart"></i>
                        <span class="text-truncate">{{ cuid.get_full_name|default:cuid.username }}</span>
                      </div>

                      {% if lista %}
                        <ul class="list-unstyled small mb-0 list-compact">
                          {% for r in lista %}
                            <li class="py-1 d-flex justify-content-between align-items-center border-bottom">
                              <span class="me-2 text-truncate">{{ r.nombre_completo }}</span>
                              <span class="text-muted ms-2 d-none d-sm-inline">{{ r.rut }}</span>
                            </li>
                          {% endfor %}
                        </ul>
                      {% else %}
                        <div class="text-muted small">Sin residentes asignados.</div>
                      {% endif %}
                    </div>
                  </div>
                {% endfor %}
              </div>
            {% else %}
              <div class="alert alert-info mb-0">A√∫n no hay asignaciones hoy.</div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{# MODAL DE CARGA #}
<div class="modal fade" id="loadingModal" tabindex="-1" aria-hidden="true"
     data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header border-0">
        <h5 class="modal-title">
          <i class="bi bi-arrow-repeat me-2 spinner-icon"></i>
          Procesando‚Ä¶
        </h5>
      </div>
      <div class="modal-body">
        <div class="progress mb-2">
          <div class="progress-bar" id="loadingProgress" role="progressbar"
               style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
            0%
          </div>
        </div>
        <p class="small text-muted mb-0">
          Por favor espera mientras se completa la operaci√≥n.
        </p>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
  @media (max-width: 576.98px) {
    .glass-card { padding: 1rem !important; }
    .card-scroll { max-height: 60vh; overflow: auto; }
    .list-compact li { padding-top: .4rem; padding-bottom: .4rem; }
  }
  @media (min-width: 577px) {
    .card-scroll { max-height: 480px; overflow: auto; }
  }
  .sticky-actions{
    position: sticky; bottom: 0;
    background: var(--bs-body-bg, #fff);
    padding-top: .75rem; margin-top: .25rem;
    border-top: 1px solid rgba(0,0,0,.06); z-index: 1;
  }
  .text-truncate { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

  /* Spinner del icono del modal */
  .spinner-icon {
    animation: spin 1s linear infinite;
  }
  @keyframes spin {
    from { transform: rotate(0deg); }
    to   { transform: rotate(360deg); }
  }
</style>
{% endblock %}

{% block extra_js %}
<script>
  (function() {
    // Seleccionar todas / ninguna
    const todasBtn = document.getElementById('btnSelTodas');
    const ningunaBtn = document.getElementById('btnSelNinguna');
    const checks = () => Array.from(document.querySelectorAll('.cuidadora-check'));
    if (todasBtn) {
      todasBtn.addEventListener('click', () => checks().forEach(ch => ch.checked = true));
    }
    if (ningunaBtn) {
      ningunaBtn.addEventListener('click', () => checks().forEach(ch => ch.checked = false));
    }

    const loadingModalEl = document.getElementById('loadingModal');
    const loadingBar = document.getElementById('loadingProgress');
    let loadingModalInstance = null;
    let loadingInterval = null;

    if (loadingModalEl && window.bootstrap) {
      loadingModalInstance = new bootstrap.Modal(loadingModalEl);
    }

    function startInterval(fromValue, toValue, step, delay, onEnd) {
      if (!loadingBar) return;
      let val = fromValue;
      loadingBar.style.width = val + '%';
      loadingBar.textContent = val + '%';
      loadingBar.setAttribute('aria-valuenow', String(val));

      if (loadingInterval) {
        clearInterval(loadingInterval);
      }
      loadingInterval = setInterval(() => {
        val += step;
        if (val >= toValue) {
          val = toValue;
          clearInterval(loadingInterval);
          loadingInterval = null;
          if (onEnd) onEnd();
        }
        loadingBar.style.width = val + '%';
        loadingBar.textContent = val + '%';
        loadingBar.setAttribute('aria-valuenow', String(val));
      }, delay);
    }

    // Cuando env√≠o el formulario ‚Üí 0% ‚Üí 90% y marco operaci√≥n pendiente
    function showLoading(operationName) {
      if (!loadingModalInstance || !loadingBar) return;
      try {
        sessionStorage.setItem('pendingLoadingOp', operationName);
      } catch (e) {
        // si falla sessionStorage, solo se ve la animaci√≥n de esta p√°gina
      }

      loadingModalInstance.show();
      startInterval(0, 90, 5, 150, null);  // 0 ‚Üí 90 y se queda ah√≠
    }

    // Al recargar despu√©s del POST ‚Üí 90% ‚Üí 100% y cerrar
    function finishLoadingIfNeeded() {
      if (!loadingModalInstance || !loadingBar) return;
      let hasPending = false;
      try {
        hasPending = !!sessionStorage.getItem('pendingLoadingOp');
      } catch (e) {
        hasPending = false;
      }
      if (!hasPending) return;

      loadingModalInstance.show();
      startInterval(90, 100, 2, 100, () => {
        loadingModalInstance.hide();
        try { sessionStorage.removeItem('pendingLoadingOp'); } catch (e) {}
      });
    }

    const formGenerar = document.getElementById('formGenerar');
    const formAviso = document.getElementById('formAviso');

    if (formGenerar) {
      formGenerar.addEventListener('submit', () => {
        showLoading('asignaciones_generar');
      });
    }
    if (formAviso) {
      formAviso.addEventListener('submit', () => {
        showLoading('asignaciones_avisar_meds');
      });
    }

    document.addEventListener('DOMContentLoaded', finishLoadingIfNeeded);
  })();
</script>
{% endblock %}
